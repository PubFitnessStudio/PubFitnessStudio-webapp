{% extends "admin_base.html" %}

{% block title %}Register New User{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-2xl shadow-xl p-8">
        <h2 class="text-3xl font-bold text-center mb-8 text-gray-800">Register New User</h2>
        
        <form id="registerForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" name="username" placeholder="Enter username" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent" 
                           required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" name="password" placeholder="Enter password" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent" 
                           required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" name="phone_no" placeholder="Enter phone number" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Device ID</label>
                    <input type="text" name="device_id" placeholder="Enter device ID" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select name="role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subscription Start Date</label>
                    <input type="date" name="sub_start_date" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subscription End Date</label>
                    <input type="date" name="sub_end_date" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Calories Goal</label>
                    <input type="number" name="calories_goal" placeholder="Daily calories goal" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Proteins Goal (g)</label>
                    <input type="number" name="proteins_goal" placeholder="Daily proteins goal" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fats Goal (g)</label>
                    <input type="number" name="fats_goal" placeholder="Daily fats goal" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Carbs Goal (g)</label>
                    <input type="number" name="carbs_goal" placeholder="Daily carbs goal" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Gender *</label>
                    <select name="gender" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent" required>
                        <option value="">Select gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer_not_to_say">Prefer not to say</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth *</label>
                    <input type="date" name="dob" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent" 
                           required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Height (cm)</label>
                    <input type="number" name="height" placeholder="Height in centimeters" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Weight (kg)</label>
                    <input type="number" name="weight" placeholder="Weight in kilograms" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                </div>
            </div>
            
            <!-- Profile Image Upload -->
            <div class="border-t pt-6">
                <div class="flex items-center mb-2">
                    <i data-feather="shield" class="w-4 h-4 text-indigo-600 mr-2"></i>
                    <label class="block text-sm font-medium text-gray-700">Profile Image (Admin Only)</label>
                </div>
                <p class="text-xs text-gray-500 mb-3">Administrators can set profile images for new users during registration.</p>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <img id="imagePreview" src="/static/default-avatar.svg" alt="Profile Preview" 
                             class="w-20 h-20 rounded-full object-cover border-2 border-gray-300">
                        <label for="profile-image-upload" class="absolute bottom-0 right-0 bg-indigo-600 text-white p-1.5 rounded-full cursor-pointer hover:bg-indigo-700 transition-colors">
                            <i data-feather="camera" class="w-3 h-3"></i>
                        </label>
                    </div>
                    <div class="flex-1">
                        <input type="file" id="profile-image-upload" name="profile_image" accept="image/*" 
                               class="hidden" onchange="handleImagePreview(event)">
                        <label for="profile-image-upload" class="cursor-pointer">
                            <div class="px-4 py-2 border border-gray-300 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 transition-colors">
                                <span class="text-sm text-gray-700">Choose an image file</span>
                            </div>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Recommended: Square image, max 5MB</p>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg shadow-md transition-colors">
                Register User
            </button>
        </form>
    </div>
</div>

<!-- Popup Modal for Registration Status -->
<div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
        <div id="statusIcon" class="text-6xl mb-4">🎉</div>
        <h3 id="statusTitle" class="text-xl font-bold mb-2">Success!</h3>
        <p id="statusMessage" class="text-gray-600 mb-6">User registered successfully!</p>
        <button onclick="closeStatusModal()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-lg transition-colors">
            OK
        </button>
    </div>
</div>

<script>
// Initialize Feather icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});

// Handle image preview
function handleImagePreview(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        event.target.value = '';
        return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('Image size should be less than 5MB.');
        event.target.value = '';
        return;
    }

    // Create preview
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('imagePreview').src = e.target.result;
    };
    reader.readAsDataURL(file);
}

document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // Convert form data to JSON, handling the image separately
    for (let [key, value] of formData.entries()) {
        if (value && key !== 'profile_image') {
            if (['calories_goal', 'proteins_goal', 'fats_goal', 'carbs_goal'].includes(key)) {
                data[key] = parseInt(value);
            } else {
                data[key] = value;
            }
        }
    }
    
    // Handle image file separately
    const imageFile = document.getElementById('profile-image-upload').files[0];
    if (imageFile) {
        data.profile_image = imageFile;
    }
    
    try {
        // Use FormData for multipart/form-data if image is present
        if (imageFile) {
            const imageFormData = new FormData();
            
            // Add all text fields
            for (let [key, value] of Object.entries(data)) {
                if (key !== 'profile_image') {
                    imageFormData.append(key, value);
                }
            }
            
            // Add image file
            imageFormData.append('profile_image', imageFile);
            
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                },
                body: imageFormData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showStatusModal('success', 'Success!', result.reason || 'User registered successfully!');
                this.reset();
                document.getElementById('imagePreview').src = '/static/default-avatar.svg';
            } else {
                handleRegistrationError(result);
            }
        } else {
            // No image, use JSON
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showStatusModal('success', 'Success!', result.reason || 'User registered successfully!');
                this.reset();
                document.getElementById('imagePreview').src = '/static/default-avatar.svg';
            } else {
                handleRegistrationError(result);
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showStatusModal('error', 'Error!', 'Network error occurred. Please try again.');
    }
});

function handleRegistrationError(result) {
    // Handle different types of error responses
    let errorMessage = 'Registration failed!';
    if (result.reason) {
        errorMessage = result.reason;
    } else if (result.error) {
        // If error is an array (validation errors), extract the first message
        if (Array.isArray(result.error)) {
            errorMessage = result.error[0]?.msg || result.error[0]?.message || 'Validation error';
        } else if (typeof result.error === 'string') {
            errorMessage = result.error;
        } else if (typeof result.error === 'object') {
            errorMessage = result.error.message || result.error.msg || 'Unknown error';
        }
    } else if (result.message) {
        errorMessage = result.message;
    }
    showStatusModal('error', 'Error!', errorMessage);
}

function showStatusModal(type, title, message) {
    const modal = document.getElementById('statusModal');
    const icon = document.getElementById('statusIcon');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');
    
    if (type === 'success') {
        icon.textContent = '🎉';
        statusTitle.className = 'text-xl font-bold mb-2 text-green-600';
        statusTitle.textContent = title;
    } else {
        icon.textContent = '❌';
        statusTitle.className = 'text-xl font-bold mb-2 text-red-600';
        statusTitle.textContent = title;
    }
    
    statusMessage.textContent = message;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeStatusModal() {
    const modal = document.getElementById('statusModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}
</script>
{% endblock %}
