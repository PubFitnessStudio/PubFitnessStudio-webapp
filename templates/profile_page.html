{% extends "user_base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <!-- Profile Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center space-x-6">
            <div class="relative">
                <img id="profile-image" src="/static/default-avatar.svg" alt="Profile" 
                     class="w-24 h-24 rounded-full object-cover border-4 border-blue-200">
                <!-- Image upload disabled for regular users -->
                <div class="absolute bottom-0 right-0 bg-gray-400 text-white p-2 rounded-full cursor-not-allowed opacity-75">
                    <i data-feather="camera" class="w-4 h-4"></i>
                </div>
                <input type="file" id="image-upload" accept="image/*" class="hidden" disabled>
                <div class="absolute -bottom-8 left-0 text-xs text-gray-500">
                    Profile image updates are managed by administrators
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800" id="profile-username">Loading...</h2>
                <p class="text-gray-600" id="profile-role">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Personal Information Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Personal Information</h3>
        
        <form id="personal-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" name="username" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="phone_no" name="phone_no" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                    <select id="gender" name="gender" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer_not_to_say">Prefer not to say</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                    <input type="date" id="dob" name="dob" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Height (cm)</label>
                    <input type="number" id="height" name="height" min="100" max="250" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Weight (kg)</label>
                    <input type="number" id="weight" name="weight" min="30" max="200" step="0.1" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="pt-4">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Update Personal Information
                </button>
            </div>
        </form>
    </div>

    <!-- Nutrition Goals Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Nutrition Goals</h3>
        
        <form id="goals-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Daily Calories Goal</label>
                    <input type="number" id="calories_goal" name="calories_goal" min="1000" max="5000" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Daily Proteins Goal (g)</label>
                    <input type="number" id="proteins_goal" name="proteins_goal" min="50" max="300" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Daily Fats Goal (g)</label>
                    <input type="number" id="fats_goal" name="fats_goal" min="20" max="150" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Daily Carbs Goal (g)</label>
                    <input type="number" id="carbs_goal" name="carbs_goal" min="100" max="500" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
            </div>
            
            <div class="pt-4">
                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    Update Nutrition Goals
                </button>
            </div>
        </form>
    </div>

    <!-- Password Update Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Update Password</h3>
        
        <form id="password-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                    <input type="password" id="current_password" name="current_password" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                    <input type="password" id="new_password" name="new_password" minlength="6" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    <p class="text-xs text-gray-500 mt-1">Minimum 6 characters required</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" minlength="6" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
            </div>
            
            <div class="pt-4">
                <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    Update Password
                </button>
            </div>
        </form>
    </div>

    <!-- BMI Report Card Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Health Metrics Report</h3>
        <p class="text-gray-600 mb-4">Your health metrics calculated from your profile information.</p>
        
        <div class="overflow-x-auto">
            <table class="w-full border-collapse border border-gray-300">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Metric</th>
                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Value</th>
                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Unit</th>
                        <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 font-medium text-blue-600">BMI</td>
                        <td class="border border-gray-300 px-4 py-3" id="bmi-value">--</td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-600">kg/m²</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm text-gray-600">Body Mass Index</td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 font-medium text-green-600">TBW</td>
                        <td class="border border-gray-300 px-4 py-3" id="tbw-value">--</td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-600">L</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm text-gray-600">Total Body Water</td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 font-medium text-purple-600">BMC</td>
                        <td class="border border-gray-300 px-4 py-3" id="bmc-value">--</td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-600">kg</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm text-gray-600">Bone Mineral Content</td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 font-medium text-orange-600">BMR</td>
                        <td class="border border-gray-300 px-4 py-3" id="bmr-value">--</td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-600">kcal/day</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm text-gray-600">Basal Metabolic Rate</td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 font-medium text-red-600">Body Fat</td>
                        <td class="border border-gray-300 px-4 py-3" id="fat-value">--</td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-600">%</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm text-gray-600">Body Fat Percentage</td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 font-medium text-indigo-600">Muscle Mass</td>
                        <td class="border border-gray-300 px-4 py-3" id="pm-value">--</td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-600">kg</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm text-gray-600">Predicted Muscle Mass</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-blue-800">
                <strong>Note:</strong> These calculations are estimates based on standard formulas. 
                For accurate measurements, consult with healthcare professionals.
            </p>
        </div>
    </div>
</div>

<script>
let userData = {};

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadUserProfile();
    setupFormHandlers();
});

// Load user profile data
async function loadUserProfile() {
    try {
        const response = await fetch('/api/user-profile', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('userToken')}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            userData = data.user;
            populateProfileForm();
            updateProfileDisplay();
            calculateHealthMetrics(); // Call calculateHealthMetrics after loading profile
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
    }
}

// Populate profile form with user data
function populateProfileForm() {
    // Personal Information
    document.getElementById('username').value = userData.username || '';
    document.getElementById('phone_no').value = userData.phone_no || '';
    document.getElementById('gender').value = userData.gender || 'prefer_not_to_say';
    document.getElementById('dob').value = userData.dob || '';
    document.getElementById('height').value = userData.height || '';
    document.getElementById('weight').value = userData.weight || '';
    
    // Nutrition Goals
    document.getElementById('calories_goal').value = userData.calories_goal || 2000;
    document.getElementById('proteins_goal').value = userData.proteins_goal || 150;
    document.getElementById('fats_goal').value = userData.fats_goal || 65;
    document.getElementById('carbs_goal').value = userData.carbs_goal || 250;
}

// Update profile display
function updateProfileDisplay() {
    document.getElementById('profile-username').textContent = userData.username || 'User';
    document.getElementById('profile-role').textContent = userData.role || 'User';
    
    if (userData.profile_img) {
        document.getElementById('profile-image').src = `data:image/jpeg;base64,${userData.profile_img}`;
    }
}

// Setup form handlers
function setupFormHandlers() {
    document.getElementById('personal-form').addEventListener('submit', handlePersonalUpdate);
    document.getElementById('goals-form').addEventListener('submit', handleGoalsUpdate);
    document.getElementById('password-form').addEventListener('submit', handlePasswordUpdate);
}

// Handle personal information update
async function handlePersonalUpdate(event) {
    event.preventDefault();
    
    try {
        const formData = {
            username: document.getElementById('username').value,
            phone_no: document.getElementById('phone_no').value,
            gender: document.getElementById('gender').value,
            dob: document.getElementById('dob').value,
            height: parseInt(document.getElementById('height').value) || null,
            weight: parseFloat(document.getElementById('weight').value) || null
        };

        const response = await fetch('/api/update-profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('userToken')}`
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            alert('Personal information updated successfully!');
            loadUserProfile(); // Reload to get updated data
            calculateHealthMetrics(); // Recalculate metrics after personal update
        } else {
            const error = await response.json();
            alert(`Error updating profile: ${error.message}`);
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Error updating profile. Please try again.');
    }
}

// Handle nutrition goals update
async function handleGoalsUpdate(event) {
    event.preventDefault();
    
    try {
        const formData = {
            calories_goal: parseInt(document.getElementById('calories_goal').value),
            proteins_goal: parseInt(document.getElementById('proteins_goal').value),
            fats_goal: parseInt(document.getElementById('fats_goal').value),
            carbs_goal: parseInt(document.getElementById('carbs_goal').value)
        };

        const response = await fetch('/api/update-goals', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('userToken')}`
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            alert('Nutrition goals updated successfully!');
            loadUserProfile(); // Reload to get updated data
        } else {
            const error = await response.json();
            alert(`Error updating goals: ${error.message}`);
        }
    } catch (error) {
        console.error('Error updating goals:', error);
        alert('Error updating goals. Please try again.');
    }
}

// Handle password update
async function handlePasswordUpdate(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    // Frontend validation
    if (newPassword.length < 6) {
        alert('New password must be at least 6 characters long.');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('New password and confirm password do not match.');
        return;
    }
    
    try {
        const formData = {
            current_password: currentPassword,
            new_password: newPassword
        };

        const response = await fetch('/api/update-password', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('userToken')}`
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            alert('Password updated successfully!');
            // Clear the password fields
            document.getElementById('current_password').value = '';
            document.getElementById('new_password').value = '';
            document.getElementById('confirm_password').value = '';
        } else {
            const error = await response.json();
            if (error.message === 'Current password is incorrect') {
                alert('Current password is incorrect. Please try again.');
            } else {
                alert(`Error updating password: ${error.message}`);
            }
        }
    } catch (error) {
        console.error('Error updating password:', error);
        alert('Error updating password. Please try again.');
    }
}

// Handle image upload (disabled for regular users)
/*
async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('Image size should be less than 5MB.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('profile_image', file);

        const response = await fetch('/api/update-profile-image', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('userToken')}`
            },
            body: formData
        });

        if (response.ok) {
            alert('Profile image updated successfully!');
            loadUserProfile(); // Reload to get updated image
        } else {
            const error = await response.json();
            alert(`Error updating image: ${error.message}`);
        }
    } catch (error) {
        console.error('Error updating image:', error);
        alert('Error updating image. Please try again.');
    }
}
*/

// Calculate health metrics based on user data
function calculateHealthMetrics() {
    const weight = parseFloat(userData.weight);
    const height = parseInt(userData.height);
    const gender = userData.gender;
    const dob = userData.dob;
    
    // Check if we have the required data
    if (!weight || !height || !gender || !dob) {
        // Hide the report section if data is incomplete
        const reportSection = document.querySelector('.bg-white.rounded-lg.shadow-md.p-6:last-child');
        if (reportSection) {
            reportSection.style.display = 'none';
        }
        return;
    }
    
    // Show the report section if it was hidden
    const reportSection = document.querySelector('.bg-white.rounded-lg.shadow-md.p-6:last-child');
    if (reportSection) {
        reportSection.style.display = 'block';
    }
    
    // Calculate age from date of birth
    const birthDate = new Date(dob);
    const today = new Date();
    const age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    const adjustedAge = monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate()) ? age - 1 : age;
    
    // Calculate health metrics using the provided formulas
    const bmiValue = weight / (height * height / 10000); // kg/m²
    const tbwValue = 0.6 * weight; // L
    const bmcValue = 0.04 * weight; // kg
    
    let bmrValue, fatValue, pmValue;
    
    if (gender === "male") {
        bmrValue = (10 * weight) + (6.25 * height) - (5 * adjustedAge) + 5;
        fatValue = (1.2 * bmiValue) + (0.23 * adjustedAge) - 10.8 - 5.4;
        pmValue = 0.2 * (weight * (1 - fatValue / 100));
    } else {
        bmrValue = (10 * weight) + (6.25 * height) - (5 * adjustedAge) - 161;
        fatValue = (1.2 * bmiValue) + (0.23 * adjustedAge) - 5.4;
        pmValue = 0.2 * (weight * (1 - fatValue / 100));
    }
    
    // Update the table with calculated values
    document.getElementById('bmi-value').textContent = bmiValue.toFixed(1);
    document.getElementById('tbw-value').textContent = tbwValue.toFixed(1);
    document.getElementById('bmc-value').textContent = bmcValue.toFixed(2);
    document.getElementById('bmr-value').textContent = Math.round(bmrValue);
    document.getElementById('fat-value').textContent = fatValue.toFixed(1);
    document.getElementById('pm-value').textContent = pmValue.toFixed(1);
    
    // Add color coding for BMI
    const bmiCell = document.getElementById('bmi-value');
    bmiCell.className = 'border border-gray-300 px-4 py-3 font-semibold';
    
    if (bmiValue < 18.5) {
        bmiCell.classList.add('text-blue-600'); // Underweight
    } else if (bmiValue >= 18.5 && bmiValue < 25) {
        bmiCell.classList.add('text-green-600'); // Normal weight
    } else if (bmiValue >= 25 && bmiValue < 30) {
        bmiCell.classList.add('text-orange-600'); // Overweight
    } else {
        bmiCell.classList.add('text-red-600'); // Obese
    }
    
    // Add color coding for body fat percentage
    const fatCell = document.getElementById('fat-value');
    fatCell.className = 'border border-gray-300 px-4 py-3 font-semibold';
    
    if (gender === "male") {
        if (fatValue < 10) {
            fatCell.classList.add('text-blue-600'); // Essential fat
        } else if (fatValue >= 10 && fatValue < 20) {
            fatCell.classList.add('text-green-600'); // Athletic
        } else if (fatValue >= 20 && fatValue < 25) {
            fatCell.classList.add('text-orange-600'); // Fitness
        } else {
            fatCell.classList.add('text-red-600'); // Above average
        }
    } else {
        if (fatValue < 18) {
            fatCell.classList.add('text-blue-600'); // Essential fat
        } else if (fatValue >= 18 && fatValue < 28) {
            fatCell.classList.add('text-green-600'); // Athletic
        } else if (fatValue >= 28 && fatValue < 35) {
            fatCell.classList.add('text-orange-600'); // Fitness
        } else {
            fatCell.classList.add('text-red-600'); // Above average
        }
    }
}

// Initialize Feather icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>
{% endblock %}
